@if(!isLoading){
<!-- <div
  style="height: 100vh"
  (mousemove)="updateArrow($event); updatePreviewIndex($event)"
  (mouseup)="endArrow($event); clearPreviewIndex()"
  (touchmove)="updateArrow($event); updatePreviewIndex($event)"
  (touchend)="endArrow($event); clearPreviewIndex()"
  (mouseleave)="clearPreviewIndex()"
> -->
<div
  style="height: 100vh"
  (mousemove)="onMouseMove($event)"
  (click)="onBackgroundClick()"
  (mouseleave)="clearPreviewIndex()"
>
  <!-- AVVERSARIO -->
  <section
    id="block-enemy"
    [style.height.vh]="displaySettings().sizes.enemy"
    class="hand"
    (mouseenter)="onHoverFaceTarget()"
    (mouseleave)="onLeaveFaceTarget()"
    (click)="confirmArrowToFace($event)"
  >
    <div style="display: flex">
      <div style="width: 30%">
        <div class="dropdown ghost">
          <input type="checkbox" id="dropdown-toggle" hidden />
          <label for="dropdown-toggle" class="dropdown-trigger">
            Avversario: {{ opponentId }} <span class="dropdown-icon">‚ñº</span>
          </label>
          <div class="dropdown-menu">
            <p>Carta in mano: {{ gameState.hands[opponentId] }} carte</p>

            <p>Vita: {{ gameState.health[opponentId] }}</p>

            <p *ngIf="gameState.crystals && gameState.maxCrystals">
              Cristalli: {{ gameState.crystals[opponentId] }} / max
              {{ gameState.maxCrystals[opponentId] }}
            </p>
            <p>barrier:{{ gameState.barrier[opponentId] }}</p>
          </div>
        </div>
      </div>

      <div style="width: 100%">
        <div class="cards-enemy">
          @if(gameState.hands[opponentId]&&gameState.hands[opponentId]>0){

          <img
            *ngFor="let c of 0 | range : gameState.hands[opponentId]"
            class="singleCardEnemy"
            [src]="baseFrameBack + frameSelectedOpponent"
          />
          }
        </div>
      </div>
    </div>
  </section>
  <div *ngIf="targetInstruction" class="target-instruction">
    {{ targetInstruction }}
  </div>
  <div cdkDropListGroup>
    <!-- INFO TURNO + BOARD -->
    <div id="block-board">
      <div
        style="height: 100%; display: flex"
        [style.height.vh]="displaySettings().sizes.board"
      >
        <section style="width: 20%" class="turn-info">
          <div class="dropdown ghost">
            <input type="checkbox" id="action-toggle" hidden />
            <label for="action-toggle" class="dropdown-trigger"
              >Azioni <span class="dropdown-icon">‚ñº</span></label
            >
            <div class="dropdown-menu">
              <div class="dropdown-item">
                <button class="button-b-size" (click)="leaveGame()">
                  concedi
                </button>
              </div>
              <div class="dropdown-item">
                <div class="game-history-panel" *ngIf="gameHistory?.length">
                  <h3>üßæ Storico</h3>
                  <div
                    class="history-entry"
                    *ngFor="let entry of gameHistory; let i = index"
                    [@fadeSlideIn]
                  >
                    <span class="type-icon">{{ getIcon(entry.type) }}</span>
                    <div class="entry-content">
                      <p>
                        <strong>{{ formatEntry(entry) }}</strong>
                      </p>
                      <small>{{ entry.timestamp | date : "shortTime" }}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="turn-center">
            <h3>Turno Di: {{ currentPlayerName }}</h3>
            <p *ngIf="!isMyTurn">‚è≥ Attendi...</p>
            <button
              class="button-b-size"
              (click)="endTurn()"
              [disabled]="!isMyTurn"
            >
              Passa Turno
            </button>
          </div>
        </section>

        <section style="width: 100%" class="board">
          <h4>Plancia</h4>

          <!-- BOARD AVVERSARIO -->
          <div class="cards-board">
            <div *ngFor="let c of opponentBoard">
              <div
                *ngIf="c.name"
                (mouseenter)="onHoverTarget(c)"
                (mouseleave)="onLeaveTarget(c)"
                (click)="confirmArrow(c, $event)"
                class="singleCardBoard"
              >
                <app-card
                  [attr.data-card-id]="c.id"
                  [isVisibileText]="false"
                  [frameTitle]="frameSelectedOpponent"
                  [card]="c"
                ></app-card>
              </div>
            </div>
          </div>

          <br />

          <!-- TUA BOARD -->
          <div
            class="cards-board"
            cdkDropList
            id="boardDropList"
            [cdkDropListData]="board"
            [cdkDropListConnectedTo]="['handDropList']"
            (cdkDropListDropped)="onDrop($event)"
            [cdkDropListSortingDisabled]="true"
          >
            <ng-container *ngFor="let c of board; let i = index">
              <div
                *ngIf="isDraggingFromHand && previewIndex === i"
                class="singleCardBoard placeholder-slot"
              ></div>

              <div
                class="singleCardBoard"
                [attr.data-index]="i"
                [attr.data-card-id]="c.id"
                (click)="startArrow($event, c)"
              >
                <!-- (touchstart)="startArrow($event, c)" -->
                <app-card
                  [isVisibileText]="false"
                  [frameTitle]="frameSelected"
                  [card]="c"
                ></app-card>
              </div>
            </ng-container>

            <!-- Aggiungi anche questo DOPO il ng-container -->
            <div
              *ngIf="isDraggingFromHand && previewIndex === board.length"
              class="singleCardBoard placeholder-slot"
            ></div>

            <!-- <div
              *ngFor="let c of board; let i = index"
              class="singleCardBoard"
              [attr.data-index]="i"
              [attr.data-card-id]="c.id"
              (mousedown)="startArrow($event, c)"
              (touchstart)="startArrow($event, c)"
            >
              <app-card
                [isVisibileText]="false"
                [frameTitle]="frameSelected"
                [card]="c"
              ></app-card>
            </div> -->
          </div>
        </section>
      </div>
    </div>

    <!-- MANO GIOCATORE -->
    <section
      id="block-player"
      style="display: flex"
      [style.height.vh]="displaySettings().sizes.player"
      class="hand"
    >
      <div style="width: 10%">
        <h4>Mano ({{ cardsInHand.length }})</h4>
        <p>Vita: {{ gameState.health[userId] }}</p>
        <p *ngIf="gameState.crystals && gameState.maxCrystals">
          Cristalli: {{ gameState.crystals[userId] }} / max
          {{ gameState.maxCrystals[userId] }}
        </p>
        <p>barrier:{{ gameState.barrier[userId] }}</p>
      </div>
      <div
        cdkDropList
        id="handDropList"
        [cdkDropListData]="cardsInHand"
        [cdkDropListConnectedTo]="['boardDropList']"
        [cdkDropListSortingDisabled]="false"
        (cdkDropListDropped)="onDrop($event)"
        class="cards-hand"
      >
        <div
          *ngFor="let c of cardsInHand"
          (cdkDragStarted)="isDraggingFromHand = true"
          (cdkDragEnded)="isDraggingFromHand = false; clearPreviewIndex()"
          class="singleCard"
          cdkDrag
        >
          <div class="drag-surface">
            <app-card [frameTitle]="frameSelected" [card]="c"></app-card>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- animazioni -->
  <!-- <div *ngIf="showCardAnim && drawnCard" class="card-drawn-overlay singleCard">
    <app-card
      [card]="drawnCard"
      [frameTitle]="frameSelected"
      [isVisibileText]="true"
    ></app-card>
  </div> -->
  <ng-template cdkPortalOutlet></ng-template>
  <!-- INSERIMENTO SVG PER LA FRECCIA -->
  <div
    *ngIf="arrowStartCard && hoveredTargetCardId && arrowPreviewPos"
    class="target-x-on-arrow"
    [style.left.px]="arrowPreviewPos.x"
    [style.top.px]="arrowPreviewPos.y"
  >
    ‚úñ
  </div>
  <svg class="arrow-layer" *ngIf="arrowStartPos && arrowPreviewPos">
    <defs>
      <marker
        id="arrowhead"
        markerWidth="10"
        markerHeight="7"
        refX="0"
        refY="3.5"
        orient="auto"
      >
        <polygon points="0 0, 10 3.5, 0 7" fill="red"></polygon>
      </marker>
    </defs>
    <line
      [attr.x1]="arrowStartPos.x"
      [attr.y1]="arrowStartPos.y"
      [attr.x2]="arrowPreviewPos.x"
      [attr.y2]="arrowPreviewPos.y"
      stroke="red"
      stroke-width="3"
      marker-end="url(#arrowhead)"
    ></line>
  </svg>
</div>
<pre>{{ gameState | json }}</pre>
} @else{ spinner }
